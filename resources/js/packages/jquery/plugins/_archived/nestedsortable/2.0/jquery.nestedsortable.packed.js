(function($){function isOverAxis(x,a,b){return(x>a)&&(x<(a+b))}$.widget("mjs.nestedSortable",$.extend({},$.ui.sortable.prototype,{options:{disableParentChange:false,doNotClear:false,expandOnHover:700,isAllowed:function(a,b,c){return true},isTree:false,listType:'ol',maxLevels:0,protectRoot:false,rootID:null,rtl:false,startCollapsed:false,tabSize:20,branchClass:'mjs-nestedSortable-branch',collapsedClass:'mjs-nestedSortable-collapsed',disableNestingClass:'mjs-nestedSortable-no-nesting',errorClass:'mjs-nestedSortable-error',expandedClass:'mjs-nestedSortable-expanded',hoveringClass:'mjs-nestedSortable-hovering',leafClass:'mjs-nestedSortable-leaf',disabledClass:'mjs-nestedSortable-disabled'},_create:function(){this.element.data('ui-sortable',this.element.data('mjs-nestedSortable'));if(!this.element.is(this.options.listType))throw new Error('nestedSortable: Please check that the listType option is set to your actual list type');if(this.options.isTree&&this.options.expandOnHover){this.options.tolerance='intersect'}$.ui.sortable.prototype._create.apply(this,arguments);if(this.options.isTree){var b=this;$(this.items).each(function(){var a=this.item;if(a.children(b.options.listType).length){a.addClass(b.options.branchClass);if(!a.hasClass(b.options.collapsedClass)&&(!a.hasClass(b.options.expandedClass))){if(b.options.startCollapsed)a.addClass(b.options.collapsedClass);else a.addClass(b.options.expandedClass)}}else{a.addClass(b.options.leafClass)}})}},_destroy:function(){this.element.removeData("mjs-nestedSortable").removeData("ui-sortable");return $.ui.sortable.prototype._destroy.apply(this,arguments)},_mouseDrag:function(b){var i,item,itemElement,intersection,o=this.options,scrolled=false;this.position=this._generatePosition(b);this.positionAbs=this._convertPositionTo("absolute");if(!this.lastPositionAbs){this.lastPositionAbs=this.positionAbs}if(this.options.scroll){if(this.scrollParent[0]!=document&&this.scrollParent[0].tagName!='HTML'){if((this.overflowOffset.top+this.scrollParent[0].offsetHeight)-b.pageY<o.scrollSensitivity){this.scrollParent[0].scrollTop=scrolled=this.scrollParent[0].scrollTop+o.scrollSpeed}else if(b.pageY-this.overflowOffset.top<o.scrollSensitivity){this.scrollParent[0].scrollTop=scrolled=this.scrollParent[0].scrollTop-o.scrollSpeed}if((this.overflowOffset.left+this.scrollParent[0].offsetWidth)-b.pageX<o.scrollSensitivity){this.scrollParent[0].scrollLeft=scrolled=this.scrollParent[0].scrollLeft+o.scrollSpeed}else if(b.pageX-this.overflowOffset.left<o.scrollSensitivity){this.scrollParent[0].scrollLeft=scrolled=this.scrollParent[0].scrollLeft-o.scrollSpeed}}else{if(b.pageY-$(document).scrollTop()<o.scrollSensitivity){scrolled=$(document).scrollTop($(document).scrollTop()-o.scrollSpeed)}else if($(window).height()-(b.pageY-$(document).scrollTop())<o.scrollSensitivity){scrolled=$(document).scrollTop($(document).scrollTop()+o.scrollSpeed)}if(b.pageX-$(document).scrollLeft()<o.scrollSensitivity){scrolled=$(document).scrollLeft($(document).scrollLeft()-o.scrollSpeed)}else if($(window).width()-(b.pageX-$(document).scrollLeft())<o.scrollSensitivity){scrolled=$(document).scrollLeft($(document).scrollLeft()+o.scrollSpeed)}}if(scrolled!==false&&$.ui.ddmanager&&!o.dropBehaviour)$.ui.ddmanager.prepareOffsets(this,b)}this.positionAbs=this._convertPositionTo("absolute");var c=this.placeholder.offset().top;if(!this.options.axis||this.options.axis!=="y"){this.helper[0].style.left=this.position.left+"px"}if(!this.options.axis||this.options.axis!=="x"){this.helper[0].style.top=this.position.top+"px"}this.hovering=this.hovering?this.hovering:null;this.mouseentered=this.mouseentered?this.mouseentered:false;var d=(this.placeholder[0].parentNode.parentNode&&$(this.placeholder[0].parentNode.parentNode).closest('.ui-sortable').length)?$(this.placeholder[0].parentNode.parentNode):null,level=this._getLevel(this.placeholder),childLevels=this._getChildLevels(this.helper);var e=document.createElement(o.listType);for(i=this.items.length-1;i>=0;i--){item=this.items[i];itemElement=item.item[0];intersection=this._intersectsWithPointer(item);if(!intersection){continue}if(item.instance!==this.currentContainer){continue}if(itemElement.className.indexOf(o.disabledClass)!==-1){if(intersection===2){var f=this.items[i+1];if(f&&f.item[0].className.indexOf(o.disabledClass)!==-1){continue}}else if(intersection===1){var g=this.items[i-1];if(g&&g.item[0].className.indexOf(o.disabledClass)!==-1){continue}}}if(itemElement!==this.currentItem[0]&&this.placeholder[intersection===1?"next":"prev"]()[0]!==itemElement&&!$.contains(this.placeholder[0],itemElement)&&(this.options.type==="semi-dynamic"?!$.contains(this.element[0],itemElement):true)){if(!this.mouseentered){$(itemElement).mouseenter();this.mouseentered=true}if(o.isTree&&$(itemElement).hasClass(o.collapsedClass)&&o.expandOnHover){if(!this.hovering){$(itemElement).addClass(o.hoveringClass);var h=this;this.hovering=window.setTimeout(function(){$(itemElement).removeClass(o.collapsedClass).addClass(o.expandedClass);h.refreshPositions();h._trigger("expand",b,h._uiHash())},o.expandOnHover)}}this.direction=intersection==1?"down":"up";if(this.options.tolerance=="pointer"||this._intersectsWithSides(item)){$(itemElement).mouseleave();this.mouseentered=false;$(itemElement).removeClass(o.hoveringClass);this.hovering&&window.clearTimeout(this.hovering);this.hovering=null;if(o.protectRoot&&!(this.currentItem[0].parentNode==this.element[0]&&itemElement.parentNode!=this.element[0])){if(this.currentItem[0].parentNode!=this.element[0]&&itemElement.parentNode==this.element[0]){if(!$(itemElement).children(o.listType).length){itemElement.appendChild(e);o.isTree&&$(itemElement).removeClass(o.leafClass).addClass(o.branchClass+' '+o.expandedClass)}var a=this.direction==="down"?$(itemElement).prev().children(o.listType):$(itemElement).children(o.listType);if(a[0]!==undefined){this._rearrange(b,null,a)}}else{this._rearrange(b,item)}}else if(!o.protectRoot){this._rearrange(b,item)}}else{break}this._clearEmpty(itemElement);this._trigger("change",b,this._uiHash());break}}var j=this.placeholder[0].previousSibling?$(this.placeholder[0].previousSibling):null;if(j!=null){while(j[0].nodeName.toLowerCase()!='li'||j[0].className.indexOf(o.disabledClass)!==-1||j[0]==this.currentItem[0]||j[0]==this.helper[0]){if(j[0].previousSibling){j=$(j[0].previousSibling)}else{j=null;break}}}var k=this.placeholder[0].nextSibling?$(this.placeholder[0].nextSibling):null;if(k!=null){while(k[0].nodeName.toLowerCase()!='li'||k[0].className.indexOf(o.disabledClass)!==-1||k[0]==this.currentItem[0]||k[0]==this.helper[0]){if(k[0].nextSibling){k=$(k[0].nextSibling)}else{k=null;break}}}this.beyondMaxLevels=0;if(d!=null&&k==null&&!(o.protectRoot&&d[0].parentNode==this.element[0])&&(o.rtl&&(this.positionAbs.left+this.helper.outerWidth()>d.offset().left+d.outerWidth())||!o.rtl&&(this.positionAbs.left<d.offset().left))){d.after(this.placeholder[0]);if(o.isTree&&d.children(o.listItem).children('li:visible:not(.ui-sortable-helper)').length<1){d.removeClass(this.options.branchClass+' '+this.options.expandedClass).addClass(this.options.leafClass)}this._clearEmpty(d[0]);this._trigger("change",b,this._uiHash())}else if(j!=null&&!j.hasClass(o.disableNestingClass)&&(j.children(o.listType).length&&j.children(o.listType).is(':visible')||!j.children(o.listType).length)&&!(o.protectRoot&&this.currentItem[0].parentNode==this.element[0])&&(o.rtl&&(this.positionAbs.left+this.helper.outerWidth()<j.offset().left+j.outerWidth()-o.tabSize)||!o.rtl&&(this.positionAbs.left>j.offset().left+o.tabSize))){this._isAllowed(j,level,level+childLevels+1);if(!j.children(o.listType).length){j[0].appendChild(e);o.isTree&&j.removeClass(o.leafClass).addClass(o.branchClass+' '+o.expandedClass)}if(c&&(c<=j.offset().top)){j.children(o.listType).prepend(this.placeholder)}else{j.children(o.listType)[0].appendChild(this.placeholder[0])}this._trigger("change",b,this._uiHash())}else{this._isAllowed(d,level,level+childLevels)}this._contactContainers(b);if($.ui.ddmanager){$.ui.ddmanager.drag(this,b)}this._trigger('sort',b,this._uiHash());this.lastPositionAbs=this.positionAbs;return false},_mouseStop:function(a,b){if(this.beyondMaxLevels){this.placeholder.removeClass(this.options.errorClass);if(this.domPosition.prev){$(this.domPosition.prev).after(this.placeholder)}else{$(this.domPosition.parent).prepend(this.placeholder)}this._trigger("revert",a,this._uiHash())}$('.'+this.options.hoveringClass).mouseleave().removeClass(this.options.hoveringClass);this.mouseentered=false;this.hovering&&window.clearTimeout(this.hovering);this.hovering=null;$.ui.sortable.prototype._mouseStop.apply(this,arguments);var c=$(this.domPosition.parent).parent().attr("id");var d=this.domPosition.prev?$(this.domPosition.prev).next().index():0;if(!(c==this._uiHash().item.parent().parent().attr("id")&&d==this._uiHash().item.index())){this._trigger("relocate",a,this._uiHash())}},_intersectsWithSides:function(a){var b=this.options.isTree?.8:.5;var c=isOverAxis(this.positionAbs.top+this.offset.click.top,a.top+(a.height*b),a.height),isOverTopHalf=isOverAxis(this.positionAbs.top+this.offset.click.top,a.top-(a.height*b),a.height),isOverRightHalf=isOverAxis(this.positionAbs.left+this.offset.click.left,a.left+(a.width/2),a.width),verticalDirection=this._getDragVerticalDirection(),horizontalDirection=this._getDragHorizontalDirection();if(this.floating&&horizontalDirection){return((horizontalDirection=="right"&&isOverRightHalf)||(horizontalDirection=="left"&&!isOverRightHalf))}else{return verticalDirection&&((verticalDirection=="down"&&c)||(verticalDirection=="up"&&isOverTopHalf))}},_contactContainers:function(a){if(this.options.protectRoot&&this.currentItem[0].parentNode==this.element[0]){return}$.ui.sortable.prototype._contactContainers.apply(this,arguments)},_clear:function(a,b){$.ui.sortable.prototype._clear.apply(this,arguments);for(var i=this.items.length-1;i>=0;i--){var c=this.items[i].item[0];this._clearEmpty(c)}},serialize:function(b){var o=$.extend({},this.options,b),items=this._getItemsAsjQuery(o&&o.connected),str=[];$(items).each(function(){var a=($(o.item||this).attr(o.attribute||'id')||'').match(o.expression||(/(.+)[-=_](.+)/)),pid=($(o.item||this).parent(o.listType).parent(o.items).attr(o.attribute||'id')||'').match(o.expression||(/(.+)[-=_](.+)/));if(a){str.push(((o.key||a[1])+'['+(o.key&&o.expression?a[1]:a[2])+']')+'='+(pid?(o.key&&o.expression?pid[1]:pid[2]):o.rootID))}});if(!str.length&&o.key){str.push(o.key+'=')}return str.join('&')},toHierarchy:function(e){var o=$.extend({},this.options,e),sDepth=o.startDepthCount||0,ret=[];$(this.element).children(o.items).each(function(){var a=_recursiveItems(this);ret.push(a)});return ret;function _recursiveItems(b){var c=($(b).attr(o.attribute||'id')||'').match(o.expression||(/(.+)[-=_](.+)/));if(c){var d={"id":c[2]};if($(b).children(o.listType).children(o.items).length>0){d.children=[];$(b).children(o.listType).children(o.items).each(function(){var a=_recursiveItems(this);d.children.push(a)})}return d}}},toArray:function(f){var o=$.extend({},this.options,f),sDepth=o.startDepthCount||0,ret=[],left=1;if(!o.excludeRoot){ret.push({"item_id":o.rootID,"parent_id":null,"depth":sDepth,"left":left,"right":($(o.items,this.element).length+1)*2});left++}$(this.element).children(o.items).each(function(){left=_recursiveArray(this,sDepth+1,left)});ret=ret.sort(function(a,b){return(a.left-b.left)});return ret;function _recursiveArray(a,b,c){var d=c+1,id,pid;if($(a).children(o.listType).children(o.items).length>0){b++;$(a).children(o.listType).children(o.items).each(function(){d=_recursiveArray($(this),b,d)});b--}id=($(a).attr(o.attribute||'id')).match(o.expression||(/(.+)[-=_](.+)/));if(b===sDepth+1){pid=o.rootID}else{var e=($(a).parent(o.listType).parent(o.items).attr(o.attribute||'id')).match(o.expression||(/(.+)[-=_](.+)/));pid=e[2]}if(id){ret.push({"item_id":id[2],"parent_id":pid,"depth":b,"left":c,"right":d})}c=d+1;return c}},_clearEmpty:function(a){var o=this.options;var b=$(a).children(o.listType);if(b.length&&!b.children().length&&!o.doNotClear){o.isTree&&$(a).removeClass(o.branchClass+' '+o.expandedClass).addClass(o.leafClass);b.remove()}else if(o.isTree&&b.length&&b.children().length&&b.is(':visible')){$(a).removeClass(o.leafClass).addClass(o.branchClass+' '+o.expandedClass)}else if(o.isTree&&b.length&&b.children().length&&!b.is(':visible')){$(a).removeClass(o.leafClass).addClass(o.branchClass+' '+o.collapsedClass)}},_getLevel:function(a){var b=1;if(this.options.listType){var c=a.closest(this.options.listType);while(c&&c.length>0&&!c.is('.ui-sortable')){b++;c=c.parent().closest(this.options.listType)}}return b},_getChildLevels:function(c,d){var e=this,o=this.options,result=0;d=d||0;$(c).children(o.listType).children(o.items).each(function(a,b){result=Math.max(e._getChildLevels(b,d+1),result)});return d?result+1:result},_isAllowed:function(a,b,c){var o=this.options,maxLevels=this.placeholder.closest('.ui-sortable').nestedSortable('option','maxLevels');var d=this.currentItem.parent().parent();var e=o.disableParentChange&&(a!==null&&!d.is(a)||a===null&&d.is('li'));if(e||!o.isAllowed(this.placeholder,a,this.currentItem)){this.placeholder.addClass(o.errorClass);if(maxLevels<c&&maxLevels!=0){this.beyondMaxLevels=c-maxLevels}else{this.beyondMaxLevels=1}}else{if(maxLevels<c&&maxLevels!=0){this.placeholder.addClass(o.errorClass);this.beyondMaxLevels=c-maxLevels}else{this.placeholder.removeClass(o.errorClass);this.beyondMaxLevels=0}}}}));$.mjs.nestedSortable.prototype.options=$.extend({},$.ui.sortable.prototype.options,$.mjs.nestedSortable.prototype.options)})(jQuery);
