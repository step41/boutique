;(function($,g,h,j){var l='ontouchstart'in g;var m=(function(){var a=h.createElement('div'),docEl=h.documentElement;if(!('pointerEvents'in a.style)){return false}a.style.pointerEvents='auto';a.style.pointerEvents='x';docEl.appendChild(a);var b=g.getComputedStyle&&g.getComputedStyle(a,'').pointerEvents==='auto';docEl.removeChild(a);return!!b})();var n=l?'touchstart':'mousedown',eMove=l?'touchmove':'mousemove',eEnd=l?'touchend':'mouseup';eCancel=l?'touchcancel':'mouseup';var o={listNodeName:'ol',itemNodeName:'li',rootClass:'dd',listClass:'dd-list',itemClass:'dd-item',dragClass:'dd-dragel',handleClass:'dd-handle',collapsedClass:'dd-collapsed',placeClass:'dd-placeholder',noDragClass:'dd-nodrag',emptyClass:'dd-empty',expandBtnHTML:'<button data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20};function Plugin(a,b){this.w=$(g);this.el=$(a);this.options=$.extend({},o,b);this.init()}Plugin.prototype={init:function(){var b=this;b.reset();b.el.data('nestable-group',this.options.group);b.placeEl=$('<div class="'+b.options.placeClass+'"/>');$.each(this.el.find(b.options.itemNodeName),function(k,a){b.setParent($(a))});b.el.on('click','button',function(e){if(b.dragEl||(!l&&e.button!==0)){return}var a=$(e.currentTarget),action=a.data('action'),item=a.parent(b.options.itemNodeName);if(action==='collapse'){b.collapseItem(item)}if(action==='expand'){b.expandItem(item)}});var c=function(e){var a=$(e.target);if(!a.hasClass(b.options.handleClass)){if(a.closest('.'+b.options.noDragClass).length){return}a=a.closest('.'+b.options.handleClass)}if(!a.length||b.dragEl||(!l&&e.button!==0)||(l&&e.touches.length!==1)){return}e.preventDefault();b.dragStart(l?e.touches[0]:e)};var d=function(e){if(b.dragEl){e.preventDefault();b.dragMove(l?e.touches[0]:e)}};var f=function(e){if(b.dragEl){e.preventDefault();b.dragStop(l?e.touches[0]:e)}};if(l){b.el[0].addEventListener(n,c,false);g.addEventListener(eMove,d,false);g.addEventListener(eEnd,f,false);g.addEventListener(eCancel,f,false)}else{b.el.on(n,c);b.w.on(eMove,d);b.w.on(eEnd,f)}},serialize:function(){var e,depth=0,list=this;step=function(b,c){var d=[],items=b.children(list.options.itemNodeName);items.each(function(){var a=$(this),item=$.extend({},a.data()),sub=a.children(list.options.listNodeName);if(sub.length){item.children=step(sub,c+1)}d.push(item)});return d};e=step(list.el.find(list.options.listNodeName).first(),depth);return e},output:function(){var a=this,output=a.data('output');if(g.JSON){console.log(g.JSON.stringify(a.nestable('serialize')))}else{console.log('JSON browser support required for this demo.')}},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0};this.moving=false;this.dragEl=null;this.dragRootEl=null;this.dragDepth=0;this.hasNewRoot=false;this.pointEl=null},expandItem:function(a){a.removeClass(this.options.collapsedClass);a.children('[data-action="expand"]').hide();a.children('[data-action="collapse"]').show();a.children(this.options.listNodeName).show()},collapseItem:function(a){var b=a.children(this.options.listNodeName);if(b.length){a.addClass(this.options.collapsedClass);a.children('[data-action="collapse"]').hide();a.children('[data-action="expand"]').show();a.children(this.options.listNodeName).hide()}},expandAll:function(){var a=this;a.el.find(a.options.itemNodeName).each(function(){a.expandItem($(this))})},collapseAll:function(){var a=this;a.el.find(a.options.itemNodeName).each(function(){a.collapseItem($(this))})},setParent:function(a){if(a.children(this.options.listNodeName).length){a.prepend($(this.options.expandBtnHTML));a.prepend($(this.options.collapseBtnHTML))}a.children('[data-action="expand"]').hide()},unsetParent:function(a){a.removeClass(this.options.collapsedClass);a.children('[data-action]').remove();a.children(this.options.listNodeName).remove()},dragStart:function(e){var a=this.mouse,target=$(e.target),dragItem=target.closest(this.options.itemNodeName);this.placeEl.css('height',dragItem.height());a.offsetX=e.offsetX!==j?e.offsetX:e.pageX-target.offset().left;a.offsetY=e.offsetY!==j?e.offsetY:e.pageY-target.offset().top;a.startX=a.lastX=e.pageX;a.startY=a.lastY=e.pageY;this.dragRootEl=this.el;this.dragEl=$(h.createElement(this.options.listNodeName)).addClass(this.options.listClass+' '+this.options.dragClass);this.dragEl.css('width',dragItem.width());dragItem.after(this.placeEl);dragItem[0].parentNode.removeChild(dragItem[0]);dragItem.appendTo(this.dragEl);$(h.body).append(this.dragEl);this.dragEl.css({'left':e.pageX-a.offsetX,'top':e.pageY-a.offsetY});var i,depth,items=this.dragEl.find(this.options.itemNodeName);for(i=0;i<items.length;i++){depth=$(items[i]).parents(this.options.listNodeName).length;if(depth>this.dragDepth){this.dragDepth=depth}}},dragStop:function(e){var a=this.dragEl.children(this.options.itemNodeName).first();a[0].parentNode.removeChild(a[0]);this.placeEl.replaceWith(a);this.dragEl.remove();this.el.trigger('change');if(this.hasNewRoot){this.dragRootEl.trigger('change')}this.reset()},dragMove:function(e){var a,parent,prev,next,depth,opt=this.options,mouse=this.mouse;this.dragEl.css({'left':e.pageX-mouse.offsetX,'top':e.pageY-mouse.offsetY});mouse.lastX=mouse.nowX;mouse.lastY=mouse.nowY;mouse.nowX=e.pageX;mouse.nowY=e.pageY;mouse.distX=mouse.nowX-mouse.lastX;mouse.distY=mouse.nowY-mouse.lastY;mouse.lastDirX=mouse.dirX;mouse.lastDirY=mouse.dirY;mouse.dirX=mouse.distX===0?0:mouse.distX>0?1:-1;mouse.dirY=mouse.distY===0?0:mouse.distY>0?1:-1;var b=Math.abs(mouse.distX)>Math.abs(mouse.distY)?1:0;if(!mouse.moving){mouse.dirAx=b;mouse.moving=true;return}if(mouse.dirAx!==b){mouse.distAxX=0;mouse.distAxY=0}else{mouse.distAxX+=Math.abs(mouse.distX);if(mouse.dirX!==0&&mouse.dirX!==mouse.lastDirX){mouse.distAxX=0}mouse.distAxY+=Math.abs(mouse.distY);if(mouse.dirY!==0&&mouse.dirY!==mouse.lastDirY){mouse.distAxY=0}}mouse.dirAx=b;if(mouse.dirAx&&mouse.distAxX>=opt.threshold){mouse.distAxX=0;prev=this.placeEl.prev(opt.itemNodeName);if(mouse.distX>0&&prev.length&&!prev.hasClass(opt.collapsedClass)){a=prev.find(opt.listNodeName).last();depth=this.placeEl.parents(opt.listNodeName).length;if(depth+this.dragDepth<=opt.maxDepth){if(!a.length){a=$('<'+opt.listNodeName+'/>').addClass(opt.listClass);a.append(this.placeEl);prev.append(a);this.setParent(prev)}else{a=prev.children(opt.listNodeName).last();a.append(this.placeEl)}}}if(mouse.distX<0){next=this.placeEl.next(opt.itemNodeName);if(!next.length){parent=this.placeEl.parent();this.placeEl.closest(opt.itemNodeName).after(this.placeEl);if(!parent.children().length){this.unsetParent(parent.parent())}}}}var c=false;if(!m){this.dragEl[0].style.visibility='hidden'}this.pointEl=$(h.elementFromPoint(e.pageX-h.body.scrollLeft,e.pageY-(g.pageYOffset||h.documentElement.scrollTop)));if(!m){this.dragEl[0].style.visibility='visible'}if(this.pointEl.hasClass(opt.handleClass)){this.pointEl=this.pointEl.parent(opt.itemNodeName)}if(this.pointEl.hasClass(opt.emptyClass)){c=true}else if(!this.pointEl.length||!this.pointEl.hasClass(opt.itemClass)){return}var d=this.pointEl.closest('.'+opt.rootClass),isNewRoot=this.dragRootEl.data('nestable-id')!==d.data('nestable-id');if(!mouse.dirAx||isNewRoot||c){if(isNewRoot&&opt.group!==d.data('nestable-group')){return}depth=this.dragDepth-1+this.pointEl.parents(opt.listNodeName).length;if(depth>opt.maxDepth){return}var f=e.pageY<(this.pointEl.offset().top+this.pointEl.height()/2);parent=this.placeEl.parent();if(c){a=$(h.createElement(opt.listNodeName)).addClass(opt.listClass);a.append(this.placeEl);this.pointEl.replaceWith(a)}else if(f){this.pointEl.before(this.placeEl)}else{this.pointEl.after(this.placeEl)}if(!parent.children().length){this.unsetParent(parent.parent())}if(!this.dragRootEl.find(opt.itemNodeName).length){this.dragRootEl.append('<div class="'+opt.emptyClass+'"/>')}if(isNewRoot){this.dragRootEl=d;this.hasNewRoot=this.el[0]!==this.dragRootEl[0]}}}};$.fn.nestable=function(b){var c=this,retval=this;c.each(function(){var a=$(this).data("nestable");if(!a){$(this).data("nestable",new Plugin(this,b));$(this).data("nestable-id",new Date().getTime())}else{if(typeof b==='string'&&typeof a[b]==='function'){retval=a[b]()}}});return retval||c}})(window.jQuery||window.Zepto,window,document);
