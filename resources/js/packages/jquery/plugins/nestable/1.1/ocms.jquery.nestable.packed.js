;(function($,m,n,o){var p='ontouchstart'in m;var q=null;var r=false;var s;var t=(function(){var a=n.createElement('div'),docEl=n.documentElement;if(!('pointerEvents'in a.style)){return false}a.style.pointerEvents='auto';a.style.pointerEvents='x';docEl.appendChild(a);var b=m.getComputedStyle&&m.getComputedStyle(a,'').pointerEvents==='auto';docEl.removeChild(a);return!!b})();var u=p?'touchstart':'mousedown',eMove=p?'touchmove':'mousemove',eEnd=p?'touchend':'mouseup',eCancel=p?'touchcancel':'mouseup';var v={listNodeName:'ol',itemNodeName:'li',rootClass:'dd',listClass:'dd-list',itemClass:'dd-item',dragClass:'dd-dragel',handleClass:'dd-handle',collapsedClass:'dd-collapsed',placeClass:'dd-placeholder',noDragClass:'dd-nodrag',noChildrenClass:'dd-nochildren',emptyClass:'dd-empty',expandBtnHTML:'<button data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20,reject:[],delay:200,expandCallback:null,collapseCallback:null,dropCallback:null,cloneNodeOnDrag:false,dragOutsideToDelete:false};function Plugin(a,b){this.w=$(n);this.el=$(a);this.options=$.extend({},v,b);this.init()}Plugin.prototype={init:function(){var b=this;b.reset();b.el.data('nestable-group',this.options.group);b.placeEl=$('<div class="'+b.options.placeClass+'"/>');$.each(this.el.find(b.options.itemNodeName),function(k,a){b.setParent($(a))});b.el.on('click','button',function(e){if(b.dragEl||(!p&&e.button!==0)){return}var a=$(e.currentTarget),action=a.data('action'),item=a.parent(b.options.itemNodeName);if(action==='collapse'){b.collapseItem(item)}if(action==='expand'){b.expandItem(item)}});var c=function(e){if(e.stopPropagation){e.stopPropagation()}if(e.preventDefault){e.preventDefault()}e.cancelBubble=true;e.returnValue=false;return false};var d=function(e){r=true;q=setTimeout(function(){if(r){q=null;var a=$(e.target);b.nestableCopy=a.closest('.'+b.options.rootClass).clone(true);if(!a.hasClass(b.options.handleClass)){if(a.closest('.'+b.options.noDragClass).length){return}a=a.closest('.'+b.options.handleClass)}if(!a.length||b.dragEl||(!p&&e.which!==1)||(p&&e.touches.length!==1)){return}e.preventDefault();b.dragStart(p?e.touches[0]:e)}},b.options.delay);e.preventDefault()};var f=function(e){if(r&&b.dragEl){e.preventDefault();b.dragMove(p?e.touches[0]:e)}};var g=function(e){clearTimeout(q);r=false;if(b.dragEl){e.preventDefault();b.dragStop(p?e.touches[0]:e)}};if(p){b.el[0].addEventListener(u,d,false);m.addEventListener(eMove,f,false);m.addEventListener(eEnd,g,false);m.addEventListener(eCancel,g,false)}else{b.el.on(u,d);b.w.on(eMove,f);b.w.on(eEnd,g)}var h=function(){if(p){b.el[0].removeEventListener(u,d,false);m.removeEventListener(eMove,f,false);m.removeEventListener(eEnd,g,false);m.removeEventListener(eCancel,g,false)}else{b.el.off(u,d);b.w.off(eMove,f);b.w.off(eEnd,g)}b.el.off('click');b.el.unbind('destroy-nestable');b.el.data("nestable",null);var a=b.el[0].getElementsByTagName('button');$(a).remove()};b.el.bind('destroy-nestable',h)},destroy:function(){this.expandAll();this.el.trigger('destroy-nestable')},serialize:function(){var e,depth=0,list=this;step=function(b,c){var d=[],items=b.children(list.options.itemNodeName);items.each(function(){var a=$(this),item=$.extend({},a.data()),sub=a.children(list.options.listNodeName);if(sub.length){item.children=step(sub,c+1)}d.push(item)});return d};e=step(list.el.find(list.options.listNodeName).first(),depth);return e},serialids:function(){var h;var j=0;var k=this;var l=function(d,e){var f=[];var g=d.children(k.options.itemNodeName);g.each(function(i){var a={};var b=$(this);var c=b.children(k.options.listNodeName);if(c.length){a[b.attr('data-id')]=l(c,e+1)}else{a[b.attr('data-id')]=[{}]}f.push(a)});return f};h=l(k.el.find(k.options.listNodeName).first(),j);return h},serialidsOldVersionNoPreserveOrder:function(){var g;var h=0;var i=this;var j=function(c,d){var e={};var f=c.children(i.options.itemNodeName);f.each(function(){var a=$(this);var b=a.children(i.options.listNodeName);if(b.length){e[a.data('id')]=j(b,d+1)}else{e[a.data('id')]={}}});return e};g=j(i.el.find(i.options.listNodeName).first(),h);return g},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0};this.moving=false;this.dragEl=null;this.dragRootEl=null;this.dragDepth=0;this.dragItem=null;this.hasNewRoot=false;this.pointEl=null;this.sourceRoot=null;this.isOutsideRoot=false},expandItem:function(a,b){b=b||false;a.removeClass(this.options.collapsedClass);a.children('[data-action="expand"]').hide();a.children('[data-action="collapse"]').show();a.children(this.options.listNodeName).show();this.el.trigger('expand',[a]);a.trigger('expand');if(b===false&&$.isFunction(this.options.expandCallback)){this.options.expandCallback.call()}},collapseItem:function(a,b){b=b||false;var c=a.children(this.options.listNodeName);if(c.length){a.addClass(this.options.collapsedClass);a.children('[data-action="collapse"]').hide();a.children('[data-action="expand"]').show();a.children(this.options.listNodeName).hide()}this.el.trigger('collapse',[a]);a.trigger('collapse');if(b===false&&$.isFunction(this.options.collapseCallback)){this.options.collapseCallback.call()}},expandAll:function(){var a=this;a.el.find(a.options.itemNodeName).each(function(){a.expandItem($(this),true)});if($.isFunction(this.options.expandCallback)){this.options.expandCallback.call()}},collapseAll:function(){var a=this;a.el.find(a.options.itemNodeName).each(function(){a.collapseItem($(this),true)});if($.isFunction(this.options.collapseCallback)){this.options.collapseCallback.call()}},setParent:function(a){if(a.children(this.options.listNodeName).length){a.prepend($(this.options.expandBtnHTML));a.prepend($(this.options.collapseBtnHTML))}if((' '+a[0].className+' ').indexOf(' '+this.options.collapsedClass+' ')>-1){a.children('[data-action="collapse"]').hide()}else{a.children('[data-action="expand"]').hide()}},unsetParent:function(a){a.removeClass(this.options.collapsedClass);a.children('[data-action]').remove();a.children(this.options.listNodeName).remove()},dragStart:function(e){var a,dragItemHeight,handleWidth,mouse=this.mouse,target=$(e.target),handleItem=target.closest('.'+this.options.handleClass);dragItem=handleItem.closest(this.options.itemNodeName);this.sourceRoot=target.closest('.'+this.options.rootClass);this.dragItem=dragItem;a=dragItem.width();dragItemHeight=dragItem.height();handleItemWidth=handleItem.width();this.placeEl.css('height',dragItemHeight);mouse.offsetX=e.offsetX!==o?e.offsetX:e.pageX-target.offset().left;mouse.offsetY=e.offsetY!==o?e.offsetY:e.pageY-target.offset().top;mouse.startX=mouse.lastX=e.pageX;mouse.startY=mouse.lastY=e.pageY;this.dragRootEl=this.el;this.dragEl=$(n.createElement(this.options.listNodeName)).addClass(this.options.listClass+' '+this.options.dragClass);this.dragEl.css('width',a);if(this.options.cloneNodeOnDrag){dragItem.after(dragItem.clone())}else{dragItem.after(this.placeEl)}dragItem[0].parentNode.removeChild(dragItem[0]);dragItem.appendTo(this.dragEl);$(n.body).append(this.dragEl);this.dragEl.css({'left':e.pageX-mouse.offsetX-a+handleItemWidth,'top':e.pageY-mouse.offsetY});var i,depth,items=this.dragEl.find(this.options.itemNodeName);for(i=0;i<items.length;i++){depth=$(items[i]).parents(this.options.listNodeName).length;if(depth>this.dragDepth){this.dragDepth=depth}}},dragStop:function(e){var a=this.dragEl.children(this.options.itemNodeName).first();a[0].parentNode.removeChild(a[0]);if(this.isOutsideRoot&&this.options.dragOutsideToDelete){var b=this.placeEl.parent();this.placeEl.remove();if(!b.children().length){this.unsetParent(b.parent())}if(!this.dragRootEl.find(this.options.itemNodeName).length){this.dragRootEl.append('<div class="'+this.options.emptyClass+'"/>')}}else{this.placeEl.replaceWith(a)}if(!this.moving){$(this.dragItem).trigger('click')}var i;var c=false;for(i in this.options.reject){var d=this.options.reject[i];if(d.rule.apply(this.dragRootEl)){var f=a.clone(true);this.dragRootEl.html(this.nestableCopy.children().clone(true));if(d.action){d.action.apply(this.dragRootEl,[f])}c=true;break}}if(!c){this.dragEl.remove();this.el.trigger('change');var g=a.parent().parent();var h=null;if(g!==null&&!g.is('.'+this.options.rootClass))h=g.data('id');if($.isFunction(this.options.dropCallback)){var j={sourceId:a.data('id'),destId:h,sourceEl:a,destParent:g,destRoot:a.closest('.'+this.options.rootClass),sourceRoot:this.sourceRoot};this.options.dropCallback.call(this,j)}if(this.hasNewRoot){this.dragRootEl.trigger('change')}this.reset()}},dragMove:function(e){var a,parent,prev,next,depth,opt=this.options,mouse=this.mouse;var b=this.dragEl.width();var c=this.dragEl.find('.'+this.options.handleClass);var d=c.width();this.dragEl.css({'left':e.pageX-mouse.offsetX-b+d,'top':e.pageY-mouse.offsetY});mouse.lastX=mouse.nowX;mouse.lastY=mouse.nowY;mouse.nowX=e.pageX;mouse.nowY=e.pageY;mouse.distX=mouse.nowX-mouse.lastX;mouse.distY=mouse.nowY-mouse.lastY;mouse.lastDirX=mouse.dirX;mouse.lastDirY=mouse.dirY;mouse.dirX=mouse.distX===0?0:mouse.distX>0?1:-1;mouse.dirY=mouse.distY===0?0:mouse.distY>0?1:-1;var f=Math.abs(mouse.distX)>Math.abs(mouse.distY)?1:0;if(!this.moving){mouse.dirAx=f;this.moving=true;return}if(mouse.dirAx!==f){mouse.distAxX=0;mouse.distAxY=0}else{mouse.distAxX+=Math.abs(mouse.distX);if(mouse.dirX!==0&&mouse.dirX!==mouse.lastDirX){mouse.distAxX=0}mouse.distAxY+=Math.abs(mouse.distY);if(mouse.dirY!==0&&mouse.dirY!==mouse.lastDirY){mouse.distAxY=0}}mouse.dirAx=f;if(mouse.dirAx&&mouse.distAxX>=opt.threshold){mouse.distAxX=0;prev=this.placeEl.prev(opt.itemNodeName);if(mouse.distX>0&&prev.length&&!prev.hasClass(opt.collapsedClass)&&!prev.hasClass(opt.noChildrenClass)){a=prev.find(opt.listNodeName).last();depth=this.placeEl.parents(opt.listNodeName).length;if(depth+this.dragDepth<=opt.maxDepth){if(!a.length){a=$('<'+opt.listNodeName+'/>').addClass(opt.listClass);a.append(this.placeEl);prev.append(a);this.setParent(prev)}else{a=prev.children(opt.listNodeName).last();a.append(this.placeEl)}}}if(mouse.distX<0){next=this.placeEl.next(opt.itemNodeName);if(!next.length){parent=this.placeEl.parent();this.placeEl.closest(opt.itemNodeName).after(this.placeEl);if(!parent.children().length){this.unsetParent(parent.parent())}}}}var g=false;if(!t){this.dragEl[0].style.visibility='hidden'}this.pointEl=$(n.elementFromPoint(e.pageX-n.documentElement.scrollLeft,e.pageY-(m.pageYOffset||n.documentElement.scrollTop)));if(this.dragRootEl.has(this.pointEl).length){this.isOutsideRoot=false;this.dragEl[0].style.opacity=1}else{this.isOutsideRoot=true;this.dragEl[0].style.opacity=0.5}var h=this.pointEl.closest('.'+opt.rootClass),isNewRoot=this.dragRootEl.data('nestable-id')!==h.data('nestable-id');this.isOutsideRoot=!h.length;if(!t){this.dragEl[0].style.visibility='visible'}if(this.pointEl.hasClass(opt.handleClass)){this.pointEl=this.pointEl.closest(opt.itemNodeName)}if(this.pointEl.hasClass(opt.emptyClass)){g=true}else if(!this.pointEl.length||!this.pointEl.hasClass(opt.itemClass)){return}if(!mouse.dirAx||isNewRoot||g){if(isNewRoot&&opt.group!==h.data('nestable-group')){return}depth=this.dragDepth-1+this.pointEl.parents(opt.listNodeName).length;if(depth>opt.maxDepth){return}var i=e.pageY<(this.pointEl.offset().top+this.pointEl.height()/2);parent=this.placeEl.parent();if(g){a=$(n.createElement(opt.listNodeName)).addClass(opt.listClass);a.append(this.placeEl);this.pointEl.replaceWith(a)}else if(i){this.pointEl.before(this.placeEl)}else{this.pointEl.after(this.placeEl)}if(!parent.children().length){this.unsetParent(parent.parent())}if(!this.dragRootEl.find(opt.itemNodeName).length){this.dragRootEl.append('<div class="'+opt.emptyClass+'"/>')}this.dragRootEl=h;if(isNewRoot){this.hasNewRoot=this.el[0]!==this.dragRootEl[0]}}}};$.fn.nestable=function(c){var d=this,retval=this;var e=function(a){var b=a||"-";function S4(){return(((1+Math.random())*0x10000)|0).toString(16).substring(1)}return(S4()+S4()+b+S4()+b+S4()+b+S4()+b+S4()+S4()+S4())};d.each(function(){var a=$(this).data('nestable');if(!a){$(this).data('nestable',new Plugin(this,c));$(this).data('nestable-id',e())}else{if(typeof c==='string'&&typeof a[c]==='function'){retval=a[c]()}}});return retval||d}})(window.jQuery||window.Zepto,window,document);
